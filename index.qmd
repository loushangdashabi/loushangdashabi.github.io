---
title: "åœ¨ R ä¸­ä½¿ç”¨ Python æ¨¡å— Mesa æ¥åˆ›å»º ABM æ¨¡å‹"
author:
  - "æ¥¼ä¸Š"
  - "Mesa å¼€å‘å›¢é˜Ÿ (æä¾›demo)"
date: "`r format(Sys.time(), '%Y-%m-%d')`"

description: >
  ä½¿ç”¨ R è°ƒç”¨ Mesa åº“æ„å»º ABMï¼Œæ¨¡å‹ demo å®Œå…¨æ¥æºäº Mesa å®˜æ–¹æ•™ç¨‹ï¼Œ
  ä»£ç ç»è¿‡è½»åº¦æ”¹ç¼–ï¼ŒæŒç»­æ›´æ–°ä¸­ã€‚
  
runtime: shiny
---

# å‡†å¤‡æ­¥éª¤

## å®‰è£… python ç¯å¢ƒå¹¶å®‰è£… mesa

(åªéœ€è¦è¿è¡Œä¸€æ¬¡)

```{r,eval=F}
#| display-language: true
library(reticulate)
install_miniconda()
conda_create(envname = "mesa-abm", python_version = "3.13.5")
py_install(c("mesa[all]","seaborn"), envname = "mesa-abm", pip = TRUE)
```

## å¯åŠ¨ python ç¯å¢ƒ

(æ¯æ¬¡éƒ½éœ€è¦è¿è¡Œ)

```{r}
#| display-language: true
library(reticulate)
use_condaenv("mesa-abm", required = TRUE)
```

## å¯¼å…¥éœ€è¦çš„ python æ¨¡å—

```{python}
#| display-language: true
import mesa
import seaborn as sns
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
```

# æ¨¡å‹ç¤ºä¾‹: Boltzmann è´¢å¯Œæ¨¡å‹

åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œæ¯ä¸ª `Agent` ä¼šåˆå§‹åŒ– 1 ä¸ªå•ä½çš„è´§å¸ï¼Œå¹¶åœ¨æ¯ä¸ª `step` ä¸­éšæœºç»™å¦ä¸€ä¸ª Agent 1 ä¸ªå•ä½çš„è´§å¸ã€‚

## åˆ›å»º Agent ç±»

`Mesa` ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªåˆ›å»ºçš„ `Agent` åˆ†é…ä¸€ä¸ªæ•´æ•°ä½œä¸º `unique_id`ã€‚

ä¸‹é¢è¿™æ®µä»£ç åˆ›å»ºäº†ä¸€ä¸ªæ–°ç±» (`class`) `MoneyAgent`ï¼Œç»§æ‰¿äº† mesa.Agent ç±»çš„å±æ€§ã€‚

`mesa.Agent` æ˜¯ `Mesa` æ¨¡å—ä¸­å®šä¹‰çš„ä¸€ä¸ªåŸºç±»ï¼Œæ‰€æœ‰çš„ `Agent` éƒ½åº”è¯¥ç»§æ‰¿è¿™ä¸ªç±»ã€‚

```{python}
#| display-language: true
class MoneyAgent(mesa.Agent):
    """An agent with fixed initial wealth."""
    
    # åˆå§‹åŒ–ï¼Œæ¯æ¬¡ä½¿ç”¨ MoneyAgent åˆ›å»ºæ–°å¯¹è±¡æ—¶éƒ½ä¼šä½¿ç”¨å¦‚ä¸‹åˆå§‹åŒ–
    def __init__(self, model): # selfä»£è¡¨å½“å‰å¯¹è±¡ï¼Œmodel ä»£è¡¨æ¨¡å‹å¯¹è±¡
      
        # å°†çˆ¶ç±»ä¸­çš„å‚æ•° model (mesa.Agent) ä¼ å…¥ï¼Œè®©AgentçŸ¥é“è‡ªå·±æ‰€å±çš„æ¨¡å‹
        super().__init__(model)

        # åˆ›å»º Agent çš„å˜é‡ wealth å¹¶è®¾ç½®åˆå§‹å€¼
        self.wealth = 1
```

## åˆ›å»ºæ¨¡å‹ç±»

åˆ›å»ºä¸€ä¸ªæ¨¡å‹ç±»ï¼Œç»§æ‰¿è‡ª `mesa.Model`ï¼Œè´Ÿè´£åˆ›å»ºã€ä¿å­˜å’Œç®¡ç†æ‰€æœ‰ `Agent`ã€‚

```{python}
#| display-language: true
class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n, seed=None): # n æ˜¯åˆ›å»ºçš„ Agent æ•°é‡ï¼Œseed æ˜¯éšæœºç§å­
        super().__init__(seed=seed)
        # åœ¨self (å³å½“å‰æ¨¡å‹) ä¸­åˆ›å»ºä¸€ä¸ªå±æ€§ num_agentsï¼Œä¿å­˜ Agent çš„æ•°é‡
        self.num_agents = n 
        # è°ƒç”¨ç±»æ–¹æ³• create_agentsï¼Œåˆ›å»º n ä¸ª Agent
        MoneyAgent.create_agents(model=self, n=n)
```

## è®© Agents "do"

é€šè¿‡ `do` è®© ABM è¿è¡Œèµ·æ¥ï¼Œ`mesa` ä¸­çš„ `do` å¯ä»¥æŒ‰ä¸åŒçš„é¡ºåºæ¿€æ´» `Agent`ã€‚

åœ¨æ¯ä¸€ä¸ª `step` ä¸­ï¼Œ(é€šå¸¸) æ¯ä¸€ä¸ª `Agent` éƒ½ä¼šè¢«æ¿€æ´»å¹¶é‡‡å–è‡ªå·±çš„è¡ŒåŠ¨ï¼Œåœ¨å†…éƒ¨å‘ç”Ÿå˜åŒ–å’Œ/æˆ–ä¸å½¼æ­¤æˆ–è€…ç¯å¢ƒäº¤äº’ã€‚

æ­¤å¤„ä½¿ç”¨ `agent.shuffle_do()` æ¥å®ç°éšæœºé‡æ–°æ’åºæ¿€æ´»é¡ºåºã€‚

```{python}
#| display-language: true
class MoneyAgent(mesa.Agent):
    """An agent with fixed initial wealth."""

    def __init__(self, model):
        super().__init__(model)
        self.wealth = 1
        # ä»¥ä¸Šä»£ç åŒä¸Š
        
        # å®šä¹‰ä¸€ä¸ªæ–¹æ³• say_hiï¼Œæ¯ä¸ª step ä¸­éƒ½ä¼šè¢«è°ƒç”¨
    def say_hi(self):
        # ä¸ºäº†æ¼”ç¤ºï¼Œè¾“å‡ºäº†æ¯ä¸ª Agent çš„ unique_id
        print(f"Hi, I am an agent, you can call me {str(self.unique_id)}.")


class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n, seed=None):
        super().__init__(seed=seed)
        self.num_agents = n

        MoneyAgent.create_agents(model=self, n=n)
        # ä»¥ä¸Šä»£ç åŒä¸Š

    # å®šä¹‰æ¨¡å‹çš„ step æ–¹æ³•
    def step(self):
        """Advance the model by one step."""
        
        # éšæœºé‡æ–°æ’åº Agent çš„æ¿€æ´»é¡ºåºï¼Œå¹¶è°ƒç”¨æ¯ä¸ª Agent çš„ say_hi æ–¹æ³•
        self.agents.shuffle_do("say_hi")
```

### è¿è¡Œæ¨¡å‹

åˆ›å»ºä¸€ä¸ªæ¨¡å‹å¯¹è±¡ (`object`) å¹¶è¿è¡Œå®ƒçš„ `step` æ–¹æ³•ã€‚

```{python}
#| display-language: true

# åˆ›å»ºæ¨¡å‹å¯¹è±¡ starter_modelï¼Œä½¿ç”¨ MoneyModel ç±»
# æ­¤å¤„çš„ 10 å¯¹åº” MoneyModel ç±»çš„ç¬¬äºŒä¸ªå‚æ•° nï¼Œè¡¨ç¤ºåˆ›å»º 10 ä¸ª Agent
starter_model = MoneyModel(10)

# è¿è¡Œæ¨¡å‹çš„ step æ–¹æ³•ï¼Œæ¿€æ´»æ‰€æœ‰ Agent
starter_model.step()
```

å¦‚æœåœ¨åˆ›å»ºå¯¹è±¡æ—¶ä¼ å…¥äº† `seed` å‚æ•°ï¼Œåˆ™æ¯æ¬¡è¿è¡Œæ¨¡å‹æ—¶ `Agent` çš„é¡ºåºä¼šä¿æŒä¸€è‡´ã€‚

```{python}
#| display-language: true
starter_model = MoneyModel(10, seed = 1234)
starter_model.step()
```

### æ¨¡å‹ä¿®æ”¹ç»ƒä¹ 

åœ¨åŸæœ‰æ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œè®© `Agent` åœ¨æ¿€æ´»æ—¶è¾“å‡ºè‡ªå·±çš„ `wealth`ã€‚

```{python}
#| display-language: true
class MoneyAgent(mesa.Agent):
    """An agent with fixed initial wealth."""

    def __init__(self, model):
        super().__init__(model)

        self.wealth = 1

    # å®šä¹‰ say_wealth æ–¹æ³•ï¼Œè¾“å‡º Agent çš„ wealth
    def say_wealth(self):
        print(f"Hi, I am an agent {self.unique_id},"
              f"and I have {self.wealth} dollars.")
        
class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n, seed=None):
        super().__init__(seed=seed)
        self.num_agents = n

        MoneyAgent.create_agents(model=self, n=n)

    def step(self):
        """Advance the model by one step."""
        
        self.agents.shuffle_do("say_wealth")
        
starter_model = MoneyModel(10)
starter_model.step()
```

## Agents äº¤æ¢è´¢å¯Œ

```{python}
#| display-language: true
class MoneyAgent(mesa.Agent):
    """An agent with fixed initial wealth."""

    def __init__(self, model):
        super().__init__(model)
        self.wealth = 1
        
    # å®šä¹‰ exchange æ–¹æ³•ï¼Œè®© Agent äº¤æ¢è´¢å¯Œ
    def exchange(self):
        if self.wealth > 0: # æœ‰é’±æ‰èƒ½è½¬è´¦
            # self.random, æ˜¯ç»§æ‰¿è‡ª mesa.Agent çš„éšæœºæ•°ç”Ÿæˆå™¨
            # .choice(...) åœ¨åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª Agent
            # è¿™é‡Œçš„self.modelæ˜¯åœ¨ä¸Šä¸€æ­¥â€”__init__ä¸­ä¼ å…¥çš„æ¨¡å‹å¯¹è±¡
            other_agent = self.random.choice(self.model.agents)
            
            if other_agent is not None: # ç¡®ä¿é€‰åˆ°äº†ä¸€ä¸ª Agent
                other_agent.wealth += 1
                self.wealth -= 1


class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n, seed=None):
        super().__init__(seed = seed)
        self.num_agents = n

        MoneyAgent.create_agents(model=self, n=n)

    def step(self):
        """Advance the model by one step."""

        self.agents.shuffle_do("exchange")
```

### è¿è¡Œæ¨¡å‹

```{python}
#| display-language: true
model = MoneyModel(10, 1234)  # åˆ›å»º 10 ä¸ª Agents

# è¿™ä¸ª for å¾ªç¯ä¸­ _ æ˜¯ä¸€ä¸ªå ä½ç¬¦
# è¡¨ç¤ºæˆ‘ä»¬ä¸å…³å¿ƒå¾ªç¯å˜é‡çš„å€¼ï¼Œä¹Ÿä¸å…³å¿ƒç°åœ¨è¿è¡Œäº†å‡ æ¬¡ï¼Œåªæ˜¯æƒ³è¿è¡Œ30æ¬¡
for _ in range(30): 
    model.step()
```

### å¯è§†åŒ–

```{python}
#| display-language: true
# è·å–æ¯ä¸ª Agent çš„ wealthï¼Œæ”¾å…¥ä¸€ä¸ªåˆ—è¡¨
agent_wealth = [a.wealth for a in model.agents]
# ç»˜åˆ¶ç›´æ–¹å›¾
g = sns.histplot(agent_wealth, discrete=True)
g.set(
    title="Wealth distribution", xlabel="Wealth", ylabel="number of agents"
);
plt.show()
```

#### ä¼ å…¥ R ä¸­ç”¨ ggplot2 å¯è§†åŒ–

```{r}
#| display-language: true
library(tidyverse)

# ä½¿ç”¨ iterate å‡½æ•°éå† model ä¸­çš„ agents
agent_wealth <- map_dbl(iterate(py$model$agents), "wealth") %>% 
  tibble(wealth = .)

ggplot(agent_wealth, aes(x = wealth)) +
  geom_histogram(binwidth = 1, boundary = 0, closed = "left",
                 color = "black", fill="red") +
  labs(
    title = "Wealth distribution",
    x     = "Wealth",
    y     = "Number of agents"
  )+ theme_bw()
```

### åˆ›å»ºå¤šä¸ªæ¨¡å‹å¯¹è±¡

ä¸ºäº†æ›´å¥½åœ°ç†è§£æ¨¡å‹è¡Œä¸ºï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªæ¨¡å‹å¯¹è±¡ï¼Œä»¥è§‚å¯Ÿæ•´ä½“åˆ†å¸ƒã€‚

```{python}
#| display-language: true
# åˆ›å»ºä¸€ä¸ªç©ºåˆ—è¡¨æ¥å­˜å‚¨å¾ªç¯ç»“æœï¼Œä¸ R ä¸­ç±»ä¼¼ï¼Œå¯ä»¥ä½¿å¾ªç¯è¿è¡Œæ›´å¿«
all_wealth = []
# è¿è¡Œ 100 æ¬¡æ¨¡å‹ï¼Œæ¯ä¸ªæ¨¡å‹æœ‰ 10 ä¸ª Agentï¼Œå¹¶è¿è¡Œ 30 æ¬¡ step
for _ in range(100):
    model = MoneyModel(10)
    for _ in range(30):
        model.step()
    # æ³¨æ„è¿™é‡Œçš„ç¼©è¿›ï¼Œè¯´æ˜ä¸‹é¢è¿™ä¸ªå¾ªç¯æ˜¯åœ¨for _ in range(100):å¾ªç¯ä¸­
    # è¿™æ ·æ¯æ¬¡è¿è¡Œä¸€ä¸ªæ¨¡å‹å°±ä¼šå­˜å‚¨æ‰€æœ‰ Agent çš„ wealth
    for agent in model.agents:
        # æ³¨æ„è¿™é‡Œä½¿ç”¨äº†å°±åœ°æ‰©å±• (append), å³ç›´æ¥å‘ all_wealth åˆ—è¡¨æ·»åŠ å…ƒç´ 
        # è¿™æ˜¯pythonçš„ä¸€ä¸ªç‰¹æ€§ï¼Œç›´æ¥åœ¨liståå¢åŠ å…ƒç´ ä¸æ˜¯ä¸€ä¸ªå¤æ‚çš„è®¡ç®—
        all_wealth.append(agent.wealth)
        
g = sns.histplot(all_wealth, discrete=True)
g.set(title="Wealth distribution", xlabel="Wealth", ylabel="number of agents");
plt.show()
```

#### åœ¨ R ä¸­è¿è¡Œæ¨¡å‹

```{r}
#| display-language: true
models <- map(1L:100L, ~{
  model <- py$MoneyModel(10L)
  walk(1L:30L, ~ model$step())
  model
})

all_wealth <- map_dfr(models, 
                      ~map_dbl(iterate(.x$agents), "wealth") %>% 
                        tibble(wealth = .))

ggplot(all_wealth, aes(x = wealth)) +
  geom_histogram(binwidth = 1, boundary = 0, closed = "left",
                 color = "black", fill="red") +
  labs(
    title = "Wealth distribution",
    x     = "Wealth",
    y     = "Number of agents"
  )+ theme_bw()
```

# æ·»åŠ ç©ºé—´

## åŸºç¡€æ¨¡å‹

ä»¥ä¸‹æ¨¡å‹å³ä¸Šè¿°è´¢å¯Œæ¨¡å‹ã€‚

```{python}
#| display-language: true
class MoneyAgent(mesa.Agent):
    """An agent with fixed initial wealth."""

    def __init__(self, model):
        super().__init__(model)
        self.wealth = 1

    def exchange(self):
        if self.wealth > 0:
            other_agent = self.random.choice(self.model.agents)
            if other_agent is not None:
                other_agent.wealth += 1
                self.wealth -= 1


class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n):
        super().__init__()
        self.num_agents = n
        MoneyAgent.create_agents(model=self, n=n)

    def step(self):
        """Advance the model by one step."""
        self.agents.shuffle_do("exchange")
```

```{python}
#| display-language: true
model = MoneyModel(10)
model.step()

print(f"You have {len(model.agents)} agents.")
```

## ç©ºé—´æ¦‚å¿µ

`Mesa` æä¾›ä¸¤ç§ç©ºé—´ç±»å‹ï¼šç¦»æ•£ç©ºé—´å’Œè¿ç»­ç©ºé—´ã€‚

-   ç¦»æ•£ç©ºé—´ï¼š`Agent` å æ®å•å…ƒæ ¼æˆ–èŠ‚ç‚¹

-   è¿ç»­ç©ºé—´ï¼š`Agent` å æ®ä¸‰ç»´ç©ºé—´ä¸­çš„ä»»ä½•ä½ç½®

ä»¥ä¸‹ä½¿ç”¨ç»å…¸ç¬›å¡å°”åæ ‡ç³»ä¸‹çš„ç¦»æ•£ç©ºé—´ï¼Œå…·æœ‰ä¸¤ä¸ªæ¨¡å—ï¼šå•å…ƒæ ¼ (`cell`) å’Œ`å•å…ƒæ ¼ Agent`ã€‚

å•å…ƒæ ¼ç±»è¡¨ç¤ºä¸€ä¸ªå…·å¤‡ä»¥ä¸‹åŠŸèƒ½çš„ä½ç½®ï¼š

-   å…·æœ‰å±æ€§ (å¦‚æ¸©åº¦ã€èµ„æºç­‰)

-   è¿½è¸ªå¹¶é™åˆ¶å…¶åŒ…å«çš„ `Agent`

-   ä¸ç›¸é‚»å•å…ƒæ ¼è¿æ¥

-   æä¾›é‚»å±… (`neighborhood`) çš„ä¿¡æ¯

`å•å…ƒæ ¼ Agent` ç±»ï¼šèƒ½å¤Ÿç†è§£å¦‚ä½•åœ¨å•å…ƒæ ¼ä¸­å­˜åœ¨å’Œç§»åŠ¨çš„ `Agent`ã€‚

-   `CellAgent`: å¯ä»¥åœ¨å•å…ƒæ ¼é—´ç§»åŠ¨çš„ `Agent`ã€‚

-   `FixedAgent`: æ°¸ä¹…å›ºå®šåœ¨å•å…ƒæ ¼ä¸Šçš„é™æ­¢ `Agent`ã€‚

-   `Grid2DMovingAgent`: å…·æœ‰ç‰¹å®šç½‘æ ¼ç§»åŠ¨èƒ½åŠ›çš„ `Agent`ã€‚

![Discrete Space](/images/Discrete_Space.png)

-   ç½‘æ ¼ (`Grid`): è§„åˆ™å¤šè¾¹å½¢

    -   æ‘©å°”é‚»åŸŸ (`Moore Grid`)ï¼šæ¯ä¸ªå•å…ƒæ ¼çš„å…«ä¸ªç›¸é‚»å•å…ƒæ ¼ã€‚

    -   å†¯è¯ºä¾æ›¼é‚»åŸŸ (`Von Neumann Grid`)ï¼šæ¯ä¸ªå•å…ƒæ ¼çš„å››ä¸ªç›¸é‚»å•å…ƒæ ¼ã€‚

    -   å…­è¾¹å½¢ (`Hex Grid`)ï¼šæ¯ä¸ªå•å…ƒæ ¼çš„å…­ä¸ªç›¸é‚»å•å…ƒæ ¼ã€‚

-   ç½‘ç»œ (`Network`): æ¯ä¸ªæ ¼ç‚¹æ˜¯å›¾ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿æ¥å…³ç³»ç”±è¾¹ï¼ˆ`edge`ï¼‰å®šä¹‰ï¼Œé€‚åˆç¤¾äº¤ç½‘ç»œã€é€šä¿¡æ‹“æ‰‘ç­‰åœºæ™¯ã€‚

![Network](/images/images.png){width="500"}

-   `Voronoi`: ä¸è§„åˆ™å¤šè¾¹å½¢åˆ’åˆ†ç©ºé—´ï¼šç»™å®šä¸€ç»„ä¸­å¿ƒç‚¹ï¼Œæ¯å—å¤šè¾¹å½¢å°±æ˜¯ä¸€ä¸ª `Cell`ï¼Œé€‚ç”¨äºåœ°ç†ç©ºé—´ç­‰ä¸è§„åˆ™ç½‘æ ¼æƒ…å½¢ã€‚

![Voronoi](/images/1_aYqqekIblklLxV7yKnBKaQ.png){width="500"}

## ä»£ç å®ç°

### åˆ›å»º CellAgent

ä¸ºäº†ä½¿æ¨¡å‹å…·æœ‰ç¦»æ•£ç©ºé—´åŠŸèƒ½ï¼Œæˆ‘ä»¬å°† `MoneyAgent` å®ä¾‹åŒ–ä¸º `CellAgent`ã€‚

`CellAgent` æ˜¯ `Agent` çš„ä¸€ä¸ªå­ç±»ï¼Œä¸“é—¨ç”¨äºåœ¨ç¦»æ•£ç©ºé—´ `discrete space` æ¨¡å—ä¸­äº¤äº’å’Œç§»åŠ¨ã€‚

```{python}
#| display-language: true
# ä¸‹é¢è¿™è¡Œimportç›¸å½“äºåªä» mesa.discrete_space ä¸­å¯¼å…¥
# CellAgent å’Œ OrthogonalMooreGrid è¿™ä¸¤ä¸ªç±»ï¼Œå¦‚æœæ­¤å¤„å¯¼å…¥
# é‚£ä¹ˆä¸‹é¢ä½¿ç”¨æ—¶ä¸éœ€è¦å†™æ˜ mesa.discrete_space.CellAgent
# è€Œå¯ä»¥ç›´æ¥ä½¿ç”¨CellAgentï¼Œç±»ä¼¼Rä¸­ dplyr::select å’Œ library(dplyr)
# from mesa.discrete_space import CellAgent, OrthogonalMooreGrid

# ä½¿ç”¨çˆ¶ç±» CellAgent æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Agent ç±» MoneyAgent
class MoneyAgent(mesa.discrete_space.CellAgent):
    """An agent with fixed initial wealth."""

    def __init__(self, model, cell): 
        super().__init__(model)
        self.cell = cell  # å°† Agent åˆå§‹åŒ–åœ¨ (x,y)ï¼Œè¿™ä¸ªä½ç½®ç”±å‚æ•° cell å†³å®š
        self.wealth = 1

    # å®šä¹‰ç§»åŠ¨å‡½æ•°ï¼Œæ§åˆ¶ Agent åœ¨å•å…ƒæ ¼ä¸­ç§»åŠ¨
    def move(self):
        # é€‰æ‹©ä¸€ä¸ªéšæœºçš„ç›¸é‚»å•å…ƒæ ¼ï¼Œé»˜è®¤åŠå¾„ä¸º 1
        self.cell = self.cell.neighborhood.select_random_cell()
    
    # å®šä¹‰äº¤æ¢è´¢å¯Œå‡½æ•°
    def give_money(self):
        # é€‰æ‹©åŒä¸€ä¸ªå•å…ƒæ ¼å†…æ‰€æœ‰éæœ¬èº«çš„ Agent
        cellmates = [
            a for a in self.cell.agents if a is not self
        ] 
        # å¦‚æœè‡ªå·±çš„è´¢å¯Œ >0, åˆ‡å­˜åœ¨åŒæ ¼å†…çš„å…¶ä»– Agent
        if self.wealth > 0 and cellmates:
            # åœ¨æ‰€æœ‰åŒæ ¼å†…çš„ Agent ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            other_agent = self.random.choice(cellmates)
            # å°†è‡ªå·±çš„è´¢å¯Œ -1ï¼Œé€‰ä¸­çš„ Agent çš„è´¢å¯Œ +1
            other_agent.wealth += 1
            self.wealth -= 1
```

### åˆ›å»ºæ¨¡å‹ç±»

```{python}
#| display-language: true
class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n, width, height, seed=None):
        super().__init__(seed=seed)
        self.num_agents = n
        # åˆ›å»ºä¸€ä¸ªæ‘©å°”é‚»åŸŸ (æ¯ä¸ªå•å…ƒæ ¼æœ‰ 4 ä¸ªé‚»å±…) ç½‘æ ¼
        self.grid = mesa.discrete_space.OrthogonalMooreGrid(
            # é•¿å®½å‚æ•°ç”±å¤–éƒ¨ä¼ å…¥ï¼Œtorusæ§åˆ¶å¯ç”¨å‘¨æœŸæ€§è¾¹ç•Œ
            # å³æœ€å³è¾¹å’Œæœ€å·¦è¾¹ç›¸æ¥ï¼Œä¸Šä¸‹ç›¸æ¥
            # æ¯ä¸ªå•å…ƒæ ¼æœ€å¤§å¯ä»¥å®¹çº³ 10 ä¸ª Agent
            (width, height), torus=True, capacity=10, random=self.random
        )

        # åˆ›å»º Agentï¼Œè¿™é‡Œå’Œå‰é¢çš„æ¨¡å‹ä¸ä¸€æ ·ï¼Œæ–°å»ºçš„ Agent è¢«å­˜å…¥äº†åˆ—è¡¨ agents
        # å› ä¸ºç«‹åˆ»è¦å¯¹ agents è¿›è¡Œæ“ä½œï¼Œè¦å°†å…¶ä¿å­˜
        # å¦‚æœç›´æ¥è°ƒç”¨ create_agentsï¼Œæ¨¡å‹ä¸­å­˜åœ¨çš„æ˜¯æ—§çš„+æ–°å»ºçš„ agents
        # å¦‚ä¸‹å†™ï¼Œæ¯æ¬¡éƒ½ä¼šè¦†ç›– agents
        agents = MoneyAgent.create_agents(
            self, # model = self
            self.num_agents, # n = self.num_agents
            # ç»™æ¯ä¸ª Agent åˆ†é…ä¸€ä¸ªéšæœºçš„å•å…ƒæ ¼
            # ä»æ‰€æœ‰å•å…ƒæ ¼ä¸­æŒ‘ k æ¬¡ï¼Œk = Agent çš„æ•°é‡
            self.random.choices(self.grid.all_cells.cells, k=self.num_agents),
        )
    
    # å®šä¹‰ stepï¼Œæ¯æ­¥è¿è¡Œä¸€æ¬¡ç§»åŠ¨å’Œä¸€æ¬¡ç»™é’±
    def step(self):
        self.agents.shuffle_do("move")
        self.agents.do("give_money")
```

### è¿è¡Œæ¨¡å‹

åœ¨ä¸€ä¸ª 10x10 çš„ç½‘æ ¼ä¸Šåˆ›å»ºä¸€ä¸ªåŒ…å« 100 ä¸ªæ™ºèƒ½ä½“çš„æ¨¡å‹ï¼Œå¹¶è¿è¡Œ 20 æ­¥ã€‚

```{python}
#| display-language: true
model = MoneyModel(100, 10, 10, 1234)
for _ in range(20):
    model.step()
```

### å¯è§†åŒ–

```{python}
#| display-language: true
agent_counts = np.zeros((model.grid.width, model.grid.height))

for cell in model.grid.all_cells:
    agent_counts[cell.coordinate] = len(cell.agents)

g = sns.heatmap(agent_counts, cmap="viridis", annot=True, cbar=False, square=True)
g.figure.set_size_inches(5, 5)
g.set(title="Number of agents on each cell of the grid");
plt.show()
```

#### ç”¨ R è¿è¡Œæ¨¡å‹

ä½¿ç”¨ `ggplot2` æ‰‹åŠ¨ç»˜åˆ¶ã€‚

```{r}
#| display-language: true
library(tidyverse)

model = py$MoneyModel(100L, 10L, 10L, 1234L)
walk(1:20L, ~model$step())

agent_counts <- map_dfr(
  iterate(model$grid$all_cells),
  ~{
    coord <- as.numeric(.x$coordinate)
    tibble(
      col   = coord[1],
      row   = coord[2],
      count = length(.x$agents)
    )
  }
)

ggplot(agent_counts,aes(col, row, fill = count, label = count)) +
  geom_tile() +
  geom_text(color = "white") +
  scale_fill_viridis_c(option = "viridis") + 
  scale_x_continuous(breaks = seq(min(agent_counts$col),
                                  max(agent_counts$col), by = 1),
                     expand = c(0,0)) +
  scale_y_reverse(breaks = seq(min(agent_counts$row),
                               max(agent_counts$row), by = 1),
                     expand = c(0,0)) +
  coord_fixed() + 
  theme_minimal() +
  ggtitle("Number of agents on each cell of the grid") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)
  ) +
  labs(x = NULL, y = NULL)
```

æˆ–è€…è°ƒç”¨ä¸€äº›æ›´æ–¹ä¾¿çš„åŒ…ï¼Œå¦‚ `tidyheatmaps`ã€‚

```{r}
#| display-language: true
library(tidyheatmaps)
tidyheatmap(agent_counts, row, col, count, colors = viridis::viridis(100),
            display_numbers = T, number_format = "%.0f", number_color = "white",
            fontsize_number = 10,legend = F,cellwidth = 30, cellheigh = 30,
            angle_col = 0,
            main = "Number of agents on each cell of the grid")
```

### æ¨¡å‹ä¿®æ”¹ç»ƒä¹ 

#### æ”¹å˜ç½‘æ ¼å°ºå¯¸

å°†ç½‘æ ¼å°ºå¯¸ä» 10x10 æ”¹ä¸º 20x20ï¼Œå¹¶è¿è¡Œæ¨¡å‹ã€‚

```{r}
#| display-language: true
model = py$MoneyModel(100L, 20L, 20L, 1234L)
walk(1:20L, ~model$step())

agent_counts <- map_dfr(
  iterate(model$grid$all_cells),
  ~{
    coord <- as.numeric(.x$coordinate)
    tibble(
      col   = coord[1],
      row   = coord[2],
      count = length(.x$agents)
    )
  }
)

tidyheatmap(agent_counts, row, col, count, colors = viridis::viridis(100),
            display_numbers = T, number_format = "%.0f", number_color = "white",
            fontsize_number = 10,legend = F,cellwidth = 15, cellheigh = 15,
            angle_col = 0,
            main = "Number of agents on each cell of the grid")
```

#### æ”¹å˜å•å…ƒæ ¼å®¹é‡

å°†å•å…ƒæ ¼å®¹é‡ä» 10 æ”¹ä¸º 3ï¼Œå¹¶è¿è¡Œæ¨¡å‹ã€‚

```{r}
#| display-language: true
model = py$MoneyModel(100L, 10L, 10L, 1234L)
model$grid$capacity = 3L
walk(1:20L, ~model$step())

agent_counts <- map_dfr(
  iterate(model$grid$all_cells),
  ~{
    coord <- as.numeric(.x$coordinate)
    tibble(
      col   = coord[1],
      row   = coord[2],
      count = length(.x$agents)
    )
  }
)

tidyheatmap(agent_counts, row, col, count, colors = viridis::viridis(100),
            display_numbers = T, number_format = "%.0f", number_color = "white",
            fontsize_number = 10,legend = F,cellwidth = 30, cellheigh = 30,
            angle_col = 0,
            main = "Number of agents on each cell of the grid")
```

#### æ”¹ä¸ºæ­£äº¤å†¯è¯ºä¾æ›¼

å°†ç½‘æ ¼ä»æ‘©å°”é‚»åŸŸæ”¹ä¸ºæ­£äº¤å†¯è¯ºä¾æ›¼é‚»åŸŸã€‚

```{python}
#| display-language: true
class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n, width, height, seed=None):
        super().__init__(seed=seed)
        self.num_agents = n
        self.grid = mesa.discrete_space.OrthogonalVonNeumannGrid(
            (width, height), torus=True, capacity=10, random=self.random
        )

        agents = MoneyAgent.create_agents(
            self,
            self.num_agents,
            self.random.choices(self.grid.all_cells.cells, k=self.num_agents),
        )

    def step(self):
        self.agents.shuffle_do("move")
        self.agents.do("give_money")
```

```{r}
#| display-language: true
model = py$MoneyModel(100L, 10L, 10L, 1234L)
walk(1:20L, ~model$step())

agent_wealth <- map_dbl(iterate(py$model$agents), "wealth") %>% 
  tibble(wealth = .)

ggplot(agent_wealth, aes(x = wealth)) +
  geom_histogram(binwidth = 1, boundary = 0, closed = "left",
                 color = "black", fill="red") +
  labs(
    title = "Wealth distribution",
    x     = "Wealth",
    y     = "Number of agents"
  )+ theme_bw()
```


# ä¸€äº›ä¸ªäººæ€»ç»“

åœ¨ `Mesa` ä¸­ï¼Œé‡è¦çš„ç±»æœ‰ä¸¤ç§ï¼š

-   `mesa.Agent`: æ‰€æœ‰çš„ `Agent` éƒ½åº”è¯¥ç»§æ‰¿è¿™ä¸ªç±»ã€‚

    -   åœ¨è¿™ä¸ªç±»ä¸­ä¼šå¯¹æ¯ä¸ª `Agent` è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ `unique_id`ã€‚

    -   åˆå§‹åŒ– (å³å®šä¹‰ `__init__`) æ—¶ä¼šä¼ å…¥æ¨¡å‹å¯¹è±¡ `model`ï¼Œè®© `Agent` çŸ¥é“è‡ªå·±æ‰€å±çš„æ¨¡å‹ã€‚

    -   åˆå§‹åŒ–æ—¶è¿˜ä¼šè®¾ç½®ä¸€äº› `Agent` çš„å±æ€§ï¼Œå¦‚ `wealth`ã€‚

    -   åœ¨è¿™ä¸ªç±»ä¸­è¿˜éœ€è¦å®šä¹‰ `Agent` çš„è¡Œä¸ºæ–¹æ³•ï¼Œå¦‚ `say_hi`ã€`exchange` ç­‰ã€‚

-   `mesa.Model`: æ‰€æœ‰çš„æ¨¡å‹éƒ½åº”è¯¥ç»§æ‰¿è¿™ä¸ªç±»ã€‚

    -   åœ¨è¿™ä¸ªç±»ä¸­ä¼šå¯¹æ¨¡å‹è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ›å»ºæ¨¡å‹çš„å±æ€§ï¼Œå¦‚ `num_agents`ã€`grid` ç­‰ã€‚

    -   åˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨ `Agent` çš„åˆ›å»ºæ–¹æ³•ï¼Œ`create_agents`ï¼Œæ¥åˆ›å»ºæ¨¡å‹ä¸­çš„ `Agent`ï¼Œå¹¶åˆå§‹åŒ– `Agent` çš„ä½ç½®ã€‚

    -   åœ¨ `step` æ–¹æ³•ä¸­ä¼šè°ƒç”¨æ‰€æœ‰ `Agent` çš„è¡Œä¸ºæ–¹æ³•ã€‚


# æ•°æ®æ”¶é›†

## åˆ›å»º model-level æ•°æ®æ”¶é›†

```{python}
#| display-language: true
from mesa.discrete_space import CellAgent, OrthogonalMooreGrid
def compute_gini(model):
  agent_wealth = [agent.wealth for agent in model.agents]
  x = sorted(agent_wealth)
  n = model.num_agents
  # è®¡ç®—åŸºå°¼ç³»æ•°
  B = sum(xi * (n - i) for i, xi in enumerate(x)) / sum(x)
  # !!!æ³¨æ„è¿™é‡Œï¼Œpythonä¸ä¼šè‡ªåŠ¨è¿”å›æœ€åä¸€ä¸ªå€¼ï¼Œå¿…é¡»æ˜¾å¼è¿”å›
  return 1 + (1 / n) - 2 * B

class MoneyAgent(CellAgent):
  def __init__(self, model, cell):
    super().__init__(model)
    self.cell = cell
    self.wealth = 1
  def move(self):
    self.cell = self.cell.neighborhood.select_random_cell()
  def give_money(self):
    cellmates = [a for a in self.cell.agents if a is not self]
    if self.wealth > 0 and cellmates:
      other_agent = self.random.choice(cellmates)
      other_agent.wealth += 1
      self.wealth -= 1

class MoneyModel(mesa.Model):
  def __init__(self, n, width, height, seed = None):
    super().__init__(seed = seed)
    self.num_agents = n
    self.grid = OrthogonalMooreGrid(
        (width, height), torus=True, capacity=10, random=self.random
    )
    # å®ä¾‹åŒ–æ•°æ®æ”¶é›†å™¨ (DataCollector)
    self.datacollector = mesa.DataCollector(
      model_reporters = {"Gini": compute_gini}, 
      agent_reporters = {"Wealth": "wealth"}
    )
    agents = MoneyAgent.create_agents(
      self,
      self.num_agents,
      self.random.choices(self.grid.all_cells.cells, k = self.num_agents)
    )
  def step(self):
    # åœ¨æ¯ä¸ª step ä¸­æ”¶é›†æ•°æ®
    self.datacollector.collect(self)
    self.agents.shuffle_do("move")
    self.agents.do("give_money")
```

## è·å– model_level æ•°æ®

```{python}
#| display-language: true
model = MoneyModel(100, 10, 10, 1234)
for _ in range(100):
    model.step()

gini = model.datacollector.get_model_vars_dataframe()
g = sns.lineplot(data=gini)
g.set(title="Gini Coefficient over Time", ylabel="Gini Coefficient");
plt.show()
```

### åœ¨ R ä¸­è¿è¡Œæ¨¡å‹

```{r}
#| display-language: true
model = py$MoneyModel(100L, 10L, 10L, 1234L)
walk(1:100L, ~model$step())

# å¯ä»¥ç›´æ¥è¿™æ ·è°ƒç”¨ python çš„ function
gini = model$datacollector$get_model_vars_dataframe()  %>%  
  rownames_to_column("step") %>% mutate(step = as.numeric(step))
gini %>% 
  ggplot(aes(x = step, y = Gini)) +
  geom_line(color = "steelblue") +
  labs(
    title = "Gini Coefficient over Time",
    x     = "Step",
    y     = "Gini Coefficient"
  ) + theme_bw()
```

## ç»ƒä¹ 

### ä»…æ˜¾ç¤ºæ•°æ®ä»¥æŸ¥çœ‹æ ¼å¼

```{r}
#| display-language: true
py$gini %>% 
  rownames_to_column("step") %>% 
  mutate(step = as.numeric(step)) %>% 
  head(6)
```

### å¢åŠ  Agent çš„æ•°é‡å’Œæ—¶é—´

#### å¢åŠ æ•°é‡

```{r}
#| display-language: true
model = py$MoneyModel(400L, 20L, 20L, 1234L)
walk(1:100L, ~model$step())

gini_r = model$datacollector$get_model_vars_dataframe()  %>%  
  rownames_to_column("step") %>% mutate(step = as.numeric(step))
gini_r %>% 
  ggplot(aes(x = step, y = Gini)) +
  geom_line() +
  labs(
    title = "Gini Coefficient over Time",
    x     = "Step",
    y     = "Gini Coefficient"
  ) + theme_bw()
```


#### å¢åŠ æ—¶é—´

```{r}
#| display-language: true
model = py$MoneyModel(100L, 10L, 10L, 1234L)
walk(1:1000L, ~model$step())

gini_r = model$datacollector$get_model_vars_dataframe()  %>%  
  rownames_to_column("step") %>% mutate(step = as.numeric(step))
gini_r %>% 
  ggplot(aes(x = step, y = Gini)) +
  geom_line() +
  labs(
    title = "Gini Coefficient over Time",
    x     = "Step",
    y     = "Gini Coefficient"
  ) + theme_bw()
```

## è·å– agent_level æ•°æ®

ç»˜åˆ¶æ¯ä¸ª `Agent` åœ¨æœ€åä¸€æ­¥çš„è´¢å¯Œåˆ†å¸ƒã€‚
```{python}
#| display-language: true
agent_wealth = model.datacollector.get_agent_vars_dataframe()
agent_wealth.head()

last_step = agent_wealth.index.get_level_values("Step").max()
end_wealth = agent_wealth.xs(last_step, level="Step")[
    "Wealth"
]

g = sns.histplot(end_wealth, discrete=True)
g.set(
    title="Distribution of wealth at the end of simulation",
    xlabel="Wealth",
    ylabel="number of agents",
);
plt.show()
```

```{r}
#| display-language: true
model = py$MoneyModel(100L, 10L, 10L, 1234L)
walk(1:100L, ~model$step())

# è¿™é‡Œæœ‰ä¸€ç‚¹éº»çƒ¦çš„æ˜¯ï¼Œnumpyä¼šå»ºç«‹ä¸€ç§å¤šé‡ç´¢å¼•çš„æ•°æ®ç»“æ„
# è½¬åŒ–ä¸º R tibble æ—¶ä¼šä¸¢æ‰æ‰€æœ‰ç´¢å¼•
# ä½†ç›´æ¥åœ¨ R ä¸­ call 
# py$model$datacollector$get_agent_vars_dataframe()$reset_index()
# ä¼šå‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨ R ä¸­è¿›è¡Œäº†ä¸€æ¬¡è½¬æ¢ï¼Œ!!!ç›®å‰ reticulate è¿˜æ²¡æœ‰æä¾›æ›´å¥½çš„è§£å†³æ–¹æ³•
agent_wealth <- model$datacollector$get_agent_vars_dataframe() %>% 
  bind_cols(
  attributes(.)$pandas.index$to_frame() %>% py_to_r(),
  .
)

head(agent_wealth)

end_wealth = agent_wealth %>% 
  filter(Step == max(Step))

ggplot()+
  geom_histogram(data = end_wealth, aes(Wealth), 
               binwidth = 1, 
               color = "black", fill="steelblue")+
  ggtitle("Distribution of wealth at the end of simulation")+
  xlab("Wealth")+
  ylab("Number of agents")+
  theme_bw()
```


ç»˜åˆ¶ `Agent` 8 çš„è´¢å¯Œå˜åŒ–ã€‚

```{r}
#| display-language: true
agent_wealth %>% filter(AgentID == 8) %>% 
  ggplot()+
  geom_line(aes(Step, Wealth),color = "steelblue")+
  ggtitle("Wealth of agent 8 over time")+
  theme_bw()

```

ç»˜åˆ¶å¤šä¸ª `Agent` çš„è´¢å¯Œå˜åŒ–ã€‚

```{r}
#| display-language: true
agent_wealth %>% filter(AgentID %in% c(3, 14, 25)) %>% 
  ggplot()+
  geom_line(aes(Step, Wealth,color = factor(AgentID)))+
  ggtitle("Wealth of agent 3, 4 and 25 over time")+
  theme_bw()
```

ç»˜åˆ¶æ‰€æœ‰ `Agent` çš„è´¢å¯Œçš„å¹³å‡å€¼å’Œç½®ä¿¡åŒºé—´ã€‚

```{r}
#| display-language: true
agent_wealth %>% 
  group_by(Step) %>% 
  summarise(mean = mean(Wealth), 
            lower = mean(Wealth) - 1.96 * sd(Wealth)/sqrt(n()), 
            upper = mean(Wealth) + 1.96 * sd(Wealth)/sqrt(n())) %>% 
  ggplot()+
  geom_line(aes(Step, mean),color = "steelblue")+
  geom_ribbon(aes(Step, ymin = lower, ymax = upper),
              fill = "steelblue", alpha = 0.2)+
  ggtitle("Average wealth over time")+
  theme_bw()

ggplot(agent_wealth, aes(x = Step, y = Wealth, group = 1)) +
  stat_summary(
    geom      = "ribbon",
    fun.data  = mean_cl_normal,
    fun.args  = list(conf.int = 0.95),
    fill      = "steelblue",
    alpha     = 0.2
  ) +
  stat_summary(
    geom = "line",
    fun  = mean,
    colour = "steelblue"
  ) +
  ggtitle("Average wealth over time") +
  theme_bw()
```


# é€šè¿‡ AgentSet ç®¡ç† Agents

`Mesa` ä½¿ç”¨åŸºäºé›†åˆçš„æ–¹æ³• `AgentSet` æ¥ç®¡ç† `Agents`ï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹ä¸ä¼šæ˜¾å¼è°ƒç”¨ã€‚

ä»¥ä¸‹å±•ç¤ºä¸¤ç§ `Agent` ç®¡ç†æ–¹æ³•ï¼š

- é€‰æ‹©(`Selecting`)ï¼šåªè®©å¯Œè£•çš„ `Agent` ç»™è´«ç©·çš„ `Agent` ä¼ é€’è´¢å¯Œã€‚

- åˆ†ç»„(`GroupBy`)ï¼šæ ¹æ®è´¢å¯Œå°† `Agent` åˆ†ç»„ã€‚


## é€‰æ‹©

åœ¨è¿™ä¸ªæ¨¡å‹å˜ä½“ä¸­ï¼Œå°†ä½¿ç”¨ `agents.select` æŠŠ  `Agent` åˆ†ä¸ºè´«å¯Œä¸¤ç§ã€‚

```{python}
#| display-language: true
def compute_gini(model):
    agent_wealths = [agent.wealth for agent in model.agents]
    x = sorted(agent_wealths)
    n = model.num_agents
    B = sum(xi * (n - i) for i, xi in enumerate(x)) / (n * sum(x))
    return 1 + (1 / n) - 2 * B


class MoneyAgent(mesa.Agent):
    """An agent with fixed initial wealth."""

    def __init__(self, model):
        super().__init__(model)
        self.wealth = 1
    # åœ¨è¿™é‡Œå®šä¹‰äº†åªç»™poor_agents ä¼ é€’è´¢å¯Œ
    def give_money(self, poor_agents):
        if self.wealth > 0:
            other_agent = self.random.choice(poor_agents)
            other_agent.wealth += 1
            self.wealth -= 1


class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n):
        super().__init__()
        self.num_agents = n

        MoneyAgent.create_agents(model=self, n=n)

        self.datacollector = mesa.DataCollector(
            model_reporters={"Gini": compute_gini}, 
            agent_reporters={"Wealth": "wealth"}
        )

    def step(self):
        self.datacollector.collect(self)
        # ç”¨ agent.select è·å–è´«å¯Œ Agent çš„åˆ—è¡¨
        # è¿™é‡Œçš„ lambda ç­‰äº R çš„åŒ¿åå‡½æ•° ~
        # åœ¨åŸæœ¬çš„æ•™ç¨‹ä¸­ï¼Œè¿™é‡Œå†™ä½œmodel.agents.select
        # è¿™åœ¨åŸç”Ÿ python ç¯å¢ƒä¸­æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºåœ¨è°ƒç”¨ model = MoneyModel(100) æ—¶
        # ä¼šåˆ›å»ºå…¨å±€å˜é‡ modelï¼Œä½†åœ¨ R ä¸­è¿è¡Œæ¨¡å‹æ—¶ï¼Œæ— æ³•æ‰¾åˆ°
        # å› æ­¤åœ¨è¿™é‡Œæ”¹å†™æˆäº†æ›´è§„èŒƒçš„ self.agents.select
        rich_agents = self.agents.select(lambda a: a.wealth >= 3)
        poor_agents = self.agents.select(lambda a: a.wealth < 3)
        # å½“æœ‰å¯Œè£•çš„ Agent æ—¶ï¼Œå¯Œè£•çš„ Agent ç»™è´«ç©·çš„ Agent ä¼ é€’è´¢å¯Œ
        if len(rich_agents) > 0:
            rich_agents.shuffle_do("give_money", poor_agents)
        else:
            poor_agents.shuffle_do("give_money", poor_agents)
```

```{r}
#| display-language: true
model = py$MoneyModel(100L)
walk(1:20L, ~model$step())

agent_wealth <- model$datacollector$get_agent_vars_dataframe() %>% 
  bind_cols(
  attributes(.)$pandas.index$to_frame() %>% py_to_r(),
  .
)

agent_wealth  %>%
  ggplot() +
  geom_histogram(aes(Wealth), fill = "steelblue",binwidth = 1, color = "black") +
  labs(
    title = "Wealth distribution",
    x     = "Wealth",
    y     = "Number of agents"
  ) + theme_bw()
```

## åˆ†ç»„

é€šè¿‡ä¸€ä¸ª characteristics å°† `Agent` åˆ†ç»„, ä¾‹å¦‚æä¾› `Green`ã€`Blue` å’Œ `Mixed` çš„ç§æ—å±æ€§ï¼Œåªåœ¨åŒç§æ—å†…ç»™é’±ã€‚

```{python}
#| display-language: true
def compute_gini(model):
    agent_wealths = [agent.wealth for agent in model.agents]
    x = sorted(agent_wealths)
    n = model.num_agents
    B = sum(xi * (n - i) for i, xi in enumerate(x)) / (n * sum(x))
    return 1 + (1 / n) - 2 * B
  
class MoneyAgent(mesa.Agent):
    """An agent with fixed initial wealth."""

    def __init__(self, model, ethnicity):
        super().__init__(model)
        self.wealth = 1
        # å®šä¹‰ Agent çš„ç§æ—
        self.ethnicity = ethnicity

    def give_money(self, similars):
        if self.wealth > 0:
            # ä»åŒç§æ—çš„ Agent ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            other_agent = self.random.choice(similars)
            other_agent.wealth += 1
            self.wealth -= 1


class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n):
        super().__init__()
        self.num_agents = n

        # åˆ›å»ºä¸€ä¸ªç§æ—åˆ—è¡¨
        ethnicities = ["Green", "Blue", "Mixed"]

        MoneyAgent.create_agents(
            model=self,
            n=self.num_agents,
            # ä»ç§æ—åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ç§æ—
            ethnicity=self.random.choices(ethnicities, k=self.num_agents),
        )

        self.datacollector = mesa.DataCollector(
            model_reporters={"Gini": compute_gini},
            agent_reporters={"Wealth": "wealth", "Ethnicity": "ethnicity"},
        )

    def step(self):
        self.datacollector.collect(self)
        # åˆ›å»ºä¸€ä¸ªå­—å…¸ï¼Œå­˜å‚¨ Agent çš„ç§æ—
        grouped_agents = self.agents.groupby("ethnicity")
        for ethnic, similars in grouped_agents:
            if ethnic != "Mixed":
                similars.shuffle_do("give_money", similars)
            else:
                similars.shuffle_do(
                    "give_money", self.agents
                )  # Mixed å¯ä»¥ç»™æ‰€æœ‰äººé’±
```

```{r}
#| display-language: true
model = py$MoneyModel(100L)
walk(1:20L, ~model$step())

agent_wealth <- model$datacollector$get_agent_vars_dataframe() %>% 
  bind_cols(
  attributes(.)$pandas.index$to_frame() %>% py_to_r(),
  .
)

agent_wealth %>% 
  ggplot()+
  geom_histogram(aes(Wealth, fill = Ethnicity),binwidth = 1, color = "black")+
  theme_bw()+
  scale_fill_manual(values = c("Green" = "darkgreen", 
                               "Blue" = "darkblue", 
                               "Mixed" = "purple3")) +
  labs(title = "Wealth distribution")
```


# å¯è§†åŒ–

## å¯¼å…¥ä¾èµ–

```{python}
#| display-language: true
from mesa.visualization import SolaraViz, make_plot_component, make_space_component
```

## åŸºç¡€æ¨¡å‹

ä¸ä¸Šè¿°æ¨¡å‹ç›¸åŒã€‚

```{python}
#| display-language: true
def compute_gini(model):
    agent_wealths = [agent.wealth for agent in model.agents]
    x = sorted(agent_wealths)
    N = model.num_agents
    B = sum(xi * (N - i) for i, xi in enumerate(x)) / (N * sum(x))
    return 1 + (1 / N) - 2 * B


class MoneyAgent(CellAgent):
    """An agent with fixed initial wealth."""

    def __init__(self, model, cell):
        """initialize a MoneyAgent instance.

        Args:
            model: A model instance
        """
        super().__init__(model)
        self.cell = cell
        self.wealth = 1

    def move(self):
        """Move the agent to a random neighboring cell."""
        self.cell = self.cell.neighborhood.select_random_cell()

    def give_money(self):
        """Give 1 unit of wealth to a random agent in the same cell."""
        cellmates = [a for a in self.cell.agents if a is not self]

        if cellmates:  # Only give money if there are other agents present
            other = self.random.choice(cellmates)
            other.wealth += 1
            self.wealth -= 1

    def step(self):
        """do one step of the agent."""
        self.move()
        if self.wealth > 0:
            self.give_money()


class MoneyModel(mesa.Model):
    """A model with some number of agents."""

    def __init__(self, n=10, width=10, height=10, seed=None):
        """Initialize a MoneyModel instance.

        Args:
            N: The number of agents.
            width: width of the grid.
            height: Height of the grid.
        """
        super().__init__(seed=seed)
        self.num_agents = n
        self.grid = OrthogonalMooreGrid((width, height), random=self.random)

        # Create agents
        MoneyAgent.create_agents(
            self,
            self.num_agents,
            self.random.choices(self.grid.all_cells.cells, k=self.num_agents),
        )

        self.datacollector = mesa.DataCollector(
            model_reporters={"Gini": compute_gini}, agent_reporters={"Wealth": "wealth"}
        )
        self.datacollector.collect(self)

    def step(self):
        """do one step of the model"""
        self.agents.shuffle_do("step")
        self.datacollector.collect(self)
```

```{r}
#| display-language: true
library(shiny)
ui <- fluidPage(
  titlePanel("Boltzmann è´¢å¯Œæ¨¡å‹ï¼ˆShinyï¼‹reticulateï¼‰"),
  sidebarLayout(
    sidebarPanel(
      sliderInput("n_agents", "ä»£ç†äººæ•°", 
                  min = 10, max = 200, value = 50, step = 1),
      sliderInput("grid_w", "ç½‘æ ¼å®½åº¦", 
                  min = 5, max = 50, value = 10, step = 1),
      sliderInput("grid_h", "ç½‘æ ¼é«˜åº¦", 
                  min = 5, max = 50, value = 10, step = 1),
      actionButton("reset_btn", "ğŸ”„ Reset"),
      actionButton("step_btn",  "â–¶ï¸ Step")
    ),
    mainPanel(
      plotOutput("grid_plot", height = "500px"),
      plotOutput("gini_plot", height = "250px")
    )
  )
)

# â€”â€” 3. Server é€»è¾‘ â€”â€” 
server <- function(input, output, session) {
  # å­˜æ¨¡å‹å®ä¾‹å’Œå†å²æ•°æ®
  model_r   <- reactiveVal(NULL)
  step_count <- reactiveVal(0L)
  gini_hist <- reactiveVal(tibble(step = 0L, Gini = compute_gini(py_to_r(
    source_python("money_model.py")  # ä¸´æ—¶ç®—ä¸€ä¸‹åˆå§‹ Gini
  )$wealth)))
  
  # â€”â€” é‡ç½®æ¨¡å‹ â€”â€” 
  observeEvent(input$reset_btn, {
    # æ–°å»º Python æ¨¡å‹å®ä¾‹
    py_model <- MoneyModel(
      n      = as.integer(input$n_agents),
      width  = as.integer(input$grid_w),
      height = as.integer(input$grid_h),
      seed   = 42L
    )
    model_r(py_model)
    step_count(0L)
    
    # åˆå§‹åŒ– Gini å†å²
    pd0 <- py_model$datacollector$get_model_vars_dataframe()$reset_index()
    df0 <- py_to_r(pd0) %>% rename(step = index)
    gini_hist(df0)
  }, ignoreNULL = FALSE)  # å¯åŠ¨æ—¶ä¹Ÿè§¦å‘ä¸€æ¬¡
  
  # â€”â€” å•æ­¥æ¨è¿› â€”â€” 
  observeEvent(input$step_btn, {
    req(model_r())
    # è°ƒç”¨ Python çš„ step()
    model_r()$step()
    # æ›´æ–°è®¡æ•°
    sc <- step_count() + 1L
    step_count(sc)
    # æ‹‰å–æœ€æ–° Gini å†å²
    pd_mod <- model_r()$datacollector$get_model_vars_dataframe()$reset_index()
    df_g <- py_to_r(pd_mod) %>% rename(step = index)
    gini_hist(df_g)
  })
  
  # â€”â€” ç»˜åˆ¶ç½‘æ ¼å›¾ â€”â€” 
  output$grid_plot <- renderPlot({
    req(model_r())
    # æ‹‰å–æ‰€æœ‰ agent çš„æœ€æ–°çŠ¶æ€
    pd_ag <- model_r()$datacollector$get_agent_vars_dataframe()$reset_index()
    df_ag <- py_to_r(pd_ag) %>%
      rename(step = level_0, agent_id = level_1, wealth = wealth) %>%
      mutate(across(c(step, agent_id), as.integer)) %>%
      filter(step == step_count())
    
    ggplot(df_ag, aes(x = x, y = y)) +
      geom_point(aes(size = wealth, color = wealth), alpha = 0.8) +
      scale_size_continuous(range = c(2, 8)) +
      scale_color_viridis_c() +
      coord_fixed(expand = FALSE) +
      labs(title = paste("Step", step_count()),
           x = NULL, y = NULL) +
      theme_minimal() +
      theme(legend.position = "right")
  })
  
  # â€”â€” ç»˜åˆ¶ Gini éšæ­¥æ•°å˜åŒ– â€”â€” 
  output$gini_plot <- renderPlot({
    df_g <- gini_hist()
    ggplot(df_g, aes(step, Gini)) +
      geom_line() +
      geom_point(size = 1.5) +
      labs(title = "Gini æŒ‡æ•°éšæ­¥æ•°å˜åŒ–",
           x = "Step", y = "Gini") +
      theme_minimal()
  })
}

shinyApp(ui, server)


```

